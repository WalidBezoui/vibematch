name: Playwright Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  playwright:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
    
    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Install Playwright browsers and system dependencies
      run: npx playwright install --with-deps

    - name: Start Firebase Emulators
      run: npm install -g firebase-tools && firebase emulators:start --export-on-exit emulator-data --import emulator-data &>/dev/null &
      # The `&>/dev/null &` runs the emulators in the background silently.
      # Adjust `emulator-data` if you have specific data you want to import/export.
    
    - name: Wait for Firebase Emulators to be ready
      # Give emulators some time to fully start. Adjust as needed.
      run: sleep 15

    - name: Start Next.js development server
      run: npm run dev &>/dev/null &
      # This runs your Next.js dev server in the background.
      # Playwright's webServer config will wait for it to be ready.
    
    - name: Wait for Next.js dev server to be ready
      # Give the Next.js server some time to fully start. Adjust as needed.
      run: sleep 20

    - name: Run Playwright tests
      run: npx playwright test
    
    - name: Upload Playwright test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

