rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // --- USER PROFILES ---
    match /users/{userId} {
      // READ: Anyone can view a user's public profile.
      allow read: if true;
      
      // CREATE: A user can create their own profile.
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // UPDATE: A user can update their own profile, but not admin-only fields.
      allow update: if request.auth != null && request.auth.uid == userId &&
                        !('adminBadge' in request.resource.data) &&
                        !('initialTrustScore' in request.resource.data);
      
      // DELETE: Deleting user profiles is not allowed.
      allow delete: if false;
    }

    // --- BRAND PROFILES ---
    match /brands/{brandId} {
      // READ: Anyone can view a brand's public profile.
      allow read: if true;
      
      // CREATE: A user can create a brand profile if they are authenticated and the brandId matches their UID.
      allow create: if request.auth != null && request.auth.uid == brandId;
      
      // UPDATE: A user can update their own brand profile.
      allow update: if request.auth != null && request.auth.uid == brandId;
      
      // DELETE: Deleting brand profiles is not allowed.
      allow delete: if false;
    }

    // --- CREATOR PROFILES ---
    match /creators/{creatorId} {
      // READ: Anyone can view a creator's public profile.
      allow read: if true;
      
      // CREATE: A user can create a creator profile if they are authenticated and the creatorId matches their UID.
      allow create: if request.auth != null && request.auth.uid == creatorId;
      
      // UPDATE: A user can update their own creator profile.
      allow update: if request.auth != null && request.auth.uid == creatorId;
      
      // DELETE: Deleting creator profiles is not allowed.
      allow delete: if false;
    }

    // --- CAMPAIGNS ---
    match /campaigns/{campaignId} {
      // READ: Authenticated users can read campaign details.
      allow read: if request.auth != null;
      
      // LIST: Anyone can list campaigns.
      allow list: if true;
      
      // CREATE: Only authenticated users who are brands can create campaigns.
      allow create: if request.auth != null && exists(/databases/$(database)/documents/brands/$(request.auth.uid));
      
      // UPDATE: Only the brand that created the campaign can update it.
      allow update: if request.auth != null && request.auth.uid == resource.data.brand_id;
      
      // DELETE: Only the brand that created the campaign can delete it.
      allow delete: if request.auth != null && request.auth.uid == resource.data.brand_id;
    }

    // --- CAMPAIGN APPLICATIONS ---
    match /campaign-applications/{applicationId} {
      // CREATE: An authenticated creator can create an application for themselves.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.creator_id;
      
      // READ: The brand owner of the campaign or the creator who applied can read the application.
      allow read: if request.auth != null && (
                          request.auth.uid == get(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)).data.brand_id ||
                          request.auth.uid == resource.data.creator_id
                       );
      
      // UPDATE: Not allowed.
      allow update: if false;
      
      // DELETE: The creator who applied can delete their own application.
      allow delete: if request.auth != null && request.auth.uid == resource.data.creator_id;
    }

    // --- JOBS ---
    match /jobs/{jobId} {
      // READ: Anyone can view job details.
      allow read: if true;
      
      // LIST: Anyone can list jobs.
      allow list: if true;
      
      // CREATE: Only authenticated users who are brands can create jobs.
      allow create: if request.auth != null && exists(/databases/$(database)/documents/brands/$(request.auth.uid));
      
      // UPDATE: Only the brand that created the job can update it.
      allow update: if request.auth != null && request.auth.uid == resource.data.brand_id;
      
      // DELETE: Deleting jobs is not allowed.
      allow delete: if false;
    }
    
    // --- JOB APPLICATIONS ---
    match /job-applications/{applicationId} {
      // CREATE: An authenticated user can create a job application.
      allow create: if request.auth != null;
      
      // READ, UPDATE, DELETE: Not allowed.
      allow read, update, delete: if false;
    }

    // --- REVIEWS ---
    match /reviews/{reviewId} {
      // READ: Anyone can read reviews.
      allow read: if true;
      
      // LIST: Anyone can list reviews.
      allow list: if true;
      
      // CREATE: An authenticated user can create a review.
      allow create: if request.auth != null;
      
      // UPDATE, DELETE: Only the user who wrote the review can modify it.
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.user_id;
    }

    // --- NOTIFICATIONS ---
    match /notifications/{notificationId} {
      // READ, WRITE: Only the recipient of the notification can access it.
      allow read, write: if request.auth != null && request.auth.uid == resource.data.user_id;
    }

    // --- CREATOR APPLICATIONS ---
    match /creator-applications/{applicationId} {
          allow create: if request.auth != null;
          allow read, update, delete: if false;
        }
    
        // --- CONVERSATION RULES ---
        match /conversations/{conversationId} {
          // CREATE: A user can create a conversation if they are listed as the brand or creator,
          // and all necessary initial fields are present.
          allow create: if request.auth != null &&
                           (request.resource.data.brand_id == request.auth.uid || request.resource.data.creator_id == request.auth.uid) &&
                           request.resource.data.campaign_id != null &&
                           request.resource.data.creator_id != null &&
                           request.resource.data.brand_id != null &&
                           request.resource.data.application_id != null;
        
          // READ & LIST: Users can only read conversations they are a part of.
          allow read, list: if request.auth != null && (resource.data.brand_id == request.auth.uid || resource.data.creator_id == request.auth.uid);
          
          // WRITE (Create & Update):
          allow write: if 
            // On create, ensure the user is a participant.
            (request.method == 'create' && (request.auth.uid == request.resource.data.creator_id || request.auth.uid == request.resource.data.brand_id)) ||
            // On update, ensure user is a participant and they are only changing allowed fields.
            (request.method == 'update' && 
              (request.auth.uid == resource.data.creator_id || request.auth.uid == resource.data.brand_id) &&
               request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'agreed_budget', 'last_offer_by', 'lastMessage', 'updatedAt', 'is_funded'])
            );
        
          // DELETE: Not allowed.
          allow delete: if false;

          // --- MESSAGES SUBCOLLECTION ---
          match /messages/{messageId} {
            // READ & LIST: Only participants of the conversation can read messages.
            allow read: if request.auth != null &&
                         (exists(/databases/$(database)/documents/conversations/$(conversationId)) &&
                          (get(/databases/$(database)/documents/conversations/$(conversationId)).data.brand_id == request.auth.uid ||
                           get(/databases/$(database)/documents/conversations/$(conversationId)).data.creator_id == request.auth.uid));
            
            // CREATE: A user can create a message if they are a participant in the conversation.
            // Removed regex patterns due to persistent parsing issues in Firestore rules.
            // Email and phone number validation should be handled in client/server-side application logic.
            allow create: if request.auth != null &&
                           (exists(/databases/$(database)/documents/conversations/$(conversationId)) &&
                            (get(/databases/$(database)/documents/conversations/$(conversationId)).data.brand_id == request.auth.uid ||
                             get(/databases/$(database)/documents/conversations/$(conversationId)).data.creator_id == request.auth.uid)) &&
                           request.resource.data.sender_id == request.auth.uid &&
                           request.resource.data.text is string &&
                           request.resource.data.timestamp is timestamp &&
                           request.resource.data.timestamp <= request.time;
            
            // UPDATE, DELETE: Not allowed.
            allow update, delete: if false;
          }
        }
  }
}
