rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow creators to query for their own applications across all campaigns.
    match /{path=**}/applications/{applicationId} {
      allow list, delete: if request.query.where.creatorId == request.auth.uid || resource.data.creatorId == request.auth.uid;
    }

    // Users can read/update their own profile.
    // A user can be created if the UID in the document matches the authenticated user's UID.
    match /users/{userId} {
      allow get: if request.auth != null;
      allow update: if request.auth.uid == userId;
      allow create: if request.auth.uid == request.resource.data.uid;
      allow list: if request.auth != null;
    }

    // Brands can create campaigns.
    // The assigned brand or creator can update the campaign.
    // Any authenticated user can list/read campaigns for discovery purposes.
    match /campaigns/{campaignId} {
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'brand' && request.resource.data.brandId == request.auth.uid;
      allow get: if request.auth != null;
      allow list: if request.auth != null;
      allow update: if resource.data.brandId == request.auth.uid || resource.data.creatorId == request.auth.uid;
      allow delete: if resource.data.brandId == request.auth.uid;

      // Applications subcollection rules
      match /applications/{applicationId} {
        // A creator can create an application for a campaign.
        allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'creator' && request.resource.data.creatorId == request.auth.uid;
        // The brand who owns the campaign can read/update applications.
        // The creator who made the application can read their own application.
        // The brand who owns the campaign can list all applications for that campaign.
        allow get, update: if get(/databases/$(database)/documents/campaigns/$(campaignId)).data.brandId == request.auth.uid || resource.data.creatorId == request.auth.uid;
        allow list: if get(/databases/$(database)/documents/campaigns/$(campaignId)).data.brandId == request.auth.uid;
        // Allow the creator to withdraw their application, or the brand owner to delete it.
        allow delete: if resource.data.creatorId == request.auth.uid || get(/databases/$(database)/documents/campaigns/$(campaignId)).data.brandId == request.auth.uid;
      }
    }
    
    // Allow anyone who is authenticated (including anonymous) to submit an application.
    // Deny read/update/delete to protect privacy.
    match /brand-applications/{applicationId} {
      allow create: if request.auth != null;
      allow read, update, delete: if false;
    }

    match /creator-applications/{applicationId} {
      allow create: if request.auth != null;
      allow read, update, delete: if false;
    }
  }
}

    